<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solitario Klondike — Black Moon</title>
<style>
  :root{
    --page-bg: #0b0b10;
    --game-bg: linear-gradient(180deg,#123 10%,#012 100%);
    --card-width: 90px;
    --card-height: 130px;
    --card-radius: 10px;
    --accent: #ffd700;
    --text: #eee;
    --panel-bg: rgba(0,0,0,0.35);
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--text);background:var(--page-bg) fixed;}
  .page{
    min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:18px;
    padding:18px;
    background-image: var(--page-bg);
    background-size:cover;
  }
  header{width:100%;max-width:1200px; display:flex; justify-content:space-between; align-items:center; gap:12px;}
  header h1{margin:0;font-size:20px;}
  #game-wrap{width:100%;max-width:1200px;background:var(--game-bg); padding:14px;border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.6);}
  .top-row{display:flex; justify-content:space-between; align-items:center; gap:12px;}
  .left-controls{display:flex; gap:12px; align-items:center;}
  .deck, .waste, .foundations{display:flex; gap:12px; align-items:center;}
  .tableau{display:flex; gap:12px; padding-top:12px; align-items:flex-start;}
  .pile{width:var(--card-width); min-height:var(--card-height); position:relative; user-select:none;}
  .card{
    width:var(--card-width); height:var(--card-height); border-radius:var(--card-radius);
    background:linear-gradient(180deg,#fff,#eee); color:#000; display:flex; flex-direction:column; justify-content:space-between;
    box-shadow:0 2px 6px rgba(0,0,0,0.4); padding:6px; font-weight:700; cursor:pointer;
    position:absolute; left:0; top:0;
    transform-origin:top left;
  }
  .card.face-down{background:linear-gradient(180deg,#223,#112); color:#fff;}
  .small{font-size:12px;}
  .meta{display:flex; gap:10px; align-items:center;}
  .panel{background:var(--panel-bg); padding:10px;border-radius:8px; display:flex; gap:10px; align-items:center;}
  footer{width:100%;max-width:1200px; margin-top:14px; color:#ccc; text-align:center; padding:10px 6px;}
  .music-controls{display:flex; gap:8px; align-items:center;}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.12); padding:6px 8px;border-radius:6px;color:var(--text);cursor:pointer;}
  .level-display{font-weight:700;}
  .link-custom{color:var(--accent); text-decoration:underline; cursor:pointer;}
  @media (max-width:900px){
    :root{--card-width:70px;--card-height:100px;}
    .tableau{overflow-x:auto; padding-bottom:10px;}
  }
</style>
</head>
<body>
<!-- ===========================
     DEVELOPER SETTINGS (EDITAR SOLO AQUÍ)
     - Cambia rutas, textos y valores aquí.
     - NO tocar más abajo salvo que sepas JS/CSS.
   ============================ -->
<script>
/* ========================= DEVELOPER SETTINGS =========================
   Solo el desarrollador debe editar esta sección.
   CARDS: array de 52 objetos. Puedes poner 'img' con URL a imagen de carta
          o dejar suit+rank y el renderer dibuja texto.
   GAME_BG / PAGE_BG: puedes poner colores, gradientes o URLs con 'url(...)'.
   MUSIC_PLAYLIST: 5 URLs (relativas o absolutas).
   FOOTER_HTML: HTML que aparecerá en el footer.
   EXTERNAL_LINK: link al que dirigirá el botón/link.
   MAX_LEVELS: 30 (puedes poner otro número).
   ======================================================================*/
const CARDS = (function(){
  // Ejemplo: representación por texto. Puedes reemplazar cada objeto por:
  // { id: 'AS', img: 'assets/cards/AS.png' }  --> si pones img se mostrará la imagen.
  const suits = ['♠','♥','♦','♣'];
  const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const arr = [];
  for(const s of suits) for(const r of ranks) arr.push({ id: r + s, suit: s, rank: r });
  // Si prefieres URLs de 52 imágenes, reemplaza arr por lista de objetos {id, img:'ruta'}
  return arr;
})();

const GAME_BG = 'linear-gradient(180deg,#0b2740 0%, #02101a 100%)'; // puedes usar 'url("/img/bg.jpg")' también
const PAGE_BG = 'linear-gradient(180deg,#02030a,#071428)';          // fondo fuera del área del juego

const MUSIC_PLAYLIST = [
  // Reemplaza por tus archivos: 'music/track1.mp3'
  'music/track1.mp3',
  'music/track2.mp3',
  'music/track3.mp3',
  'music/track4.mp3',
  'music/track5.mp3'
];

const FOOTER_HTML = `© Grupo Black Moon — Evento "Amigos del Aire" — <span class="link-custom" id="footer-link">Visita nuestro sitio</span>`;
const EXTERNAL_LINK = 'https://tusitio.example.com';

const MAX_LEVELS = 30;
// Tiempo base por nivel (segundos). Nivel 1 => TIME_BASE + (level-1)*INC
const TIME_BASE = 300; // 5 minutos base
const TIME_INC = -5;   // a cada nivel el tiempo baja 5s (puedes cambiar)
const REDEALS_BASE = 3; // cuántas veces redealar permitidas
/* ========================= FIN DE DEVELOPER SETTINGS ===================== */
</script>

<div class="page" id="page">
  <header>
    <h1>Solitario Klondike — Black Moon</h1>
    <div class="meta">
      <div class="panel">
        <div>Nivel: <span id="level" class="level-display">1</span>/<span id="max-level">30</span></div>
        <div>Puntos: <span id="score">0</span></div>
        <div>Timer: <span id="timer">00:00</span></div>
      </div>
      <div class="panel music-controls" id="music-panel">
        <button class="btn" id="prev-music">⏮</button>
        <button class="btn" id="play-music">▶</button>
        <button class="btn" id="next-music">⏭</button>
        <label class="small">Vol</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.5">
      </div>
    </div>
  </header>

  <div id="game-wrap">
    <div class="top-row">
      <div class="left-controls">
        <div class="panel">
          <div class="deck" id="stock-area">
            <div class="pile" id="stock" title="Mazo"></div>
            <div class="pile" id="waste" title="Descarte"></div>
          </div>
          <div style="width:18px"></div>
          <div class="foundations" id="foundations">
            <!-- 4 foundations generadas por JS -->
          </div>
        </div>
        <div class="panel">
          <button class="btn" id="restart-btn">Reiniciar</button>
          <button class="btn" id="redeal-btn">Redeal (<span id="redeal-count">0</span>)</button>
          <button class="btn" id="hint-btn">Hint</button>
        </div>
      </div>

      <div class="panel">
        <label class="small">Tamaño reproductor</label>
        <select id="player-size">
          <option value="mini">Mini</option>
          <option value="normal" selected>Normal</option>
        </select>
        <label class="small">Fondo de página</label>
        <input id="page-bg-input" placeholder="CSS o url(...)" style="min-width:160px">
        <label class="small">Fondo juego</label>
        <input id="game-bg-input" placeholder="CSS o url(...)" style="min-width:160px">
        <button class="btn" id="apply-bg">Aplicar</button>
      </div>
    </div>

    <div class="tableau" id="tableau"></div>
  </div>

  <footer id="footer" class="panel" style="max-width:1200px;">
    <!-- footer editable -->
  </footer>
</div>

<script>
/* ========================= GAME ENGINE (NO EDITAR A MENOS QUE SEPAS) ========================= */
(() => {
  // Init visual settings from developer variables
  document.documentElement.style.setProperty('--page-bg', PAGE_BG);
  document.documentElement.style.setProperty('--game-bg', GAME_BG);
  document.getElementById('max-level').textContent = MAX_LEVELS;
  document.getElementById('footer').innerHTML = FOOTER_HTML;
  document.getElementById('footer-link')?.addEventListener('click', ()=> window.open(EXTERNAL_LINK,'_blank'));

  // Music player
  const audio = new Audio();
  let playlist = MUSIC_PLAYLIST.slice();
  let trackIdx = 0;
  audio.src = playlist[trackIdx] || '';
  audio.loop = false;
  audio.volume = 0.5;
  const playBtn = document.getElementById('play-music');
  document.getElementById('vol').addEventListener('input', e=> audio.volume = parseFloat(e.target.value));
  document.getElementById('prev-music').addEventListener('click', ()=> {
    trackIdx = (trackIdx-1+playlist.length)%playlist.length; audio.src = playlist[trackIdx]; audio.play(); updatePlayBtn();
  });
  document.getElementById('next-music').addEventListener('click', ()=> {
    trackIdx = (trackIdx+1)%playlist.length; audio.src = playlist[trackIdx]; audio.play(); updatePlayBtn();
  });
  playBtn.addEventListener('click', ()=> {
    if(audio.paused) audio.play(); else audio.pause(); updatePlayBtn();
  });
  audio.addEventListener('play', updatePlayBtn);
  audio.addEventListener('pause', updatePlayBtn);
  function updatePlayBtn(){ playBtn.textContent = audio.paused ? '▶' : '⏸'; }

  // Player size
  document.getElementById('player-size').addEventListener('change', e=>{
    const s = e.target.value;
    if(s==='mini'){ audio.volume = 0.4; document.getElementById('music-panel').style.fontSize='12px'; }
    else { audio.volume = 0.6; document.getElementById('music-panel').style.fontSize='16px'; }
  });

  // Background inputs
  document.getElementById('page-bg-input').value = PAGE_BG;
  document.getElementById('game-bg-input').value = GAME_BG;
  document.getElementById('apply-bg').addEventListener('click', ()=>{
    const p = document.getElementById('page-bg-input').value || PAGE_BG;
    const g = document.getElementById('game-bg-input').value || GAME_BG;
    document.documentElement.style.setProperty('--page-bg', p);
    document.documentElement.style.setProperty('--game-bg', g);
  });

  /* GAME STATE */
  let deck = []; // cartas disponibles
  let stock = [], waste = [], foundations = [[],[],[],[]], tableau = [[],[],[],[],[],[],[]];
  let score = 0;
  let level = 1;
  let timerSeconds = Math.max(30, TIME_BASE + (level-1)*TIME_INC);
  let timerInterval = null;
  let redealsLeft = REDEALS_BASE;
  const maxLevels = MAX_LEVELS;

  // DOM areas
  const stockDom = document.getElementById('stock');
  const wasteDom = document.getElementById('waste');
  const tableauDom = document.getElementById('tableau');
  const foundationsDom = document.getElementById('foundations');
  const scoreEl = document.getElementById('score');
  const levelEl = document.getElementById('level');
  const timerEl = document.getElementById('timer');
  const redealCountEl = document.getElementById('redeal-count');
  redealCountEl.textContent = redealsLeft;

  // Utilities
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
  function formatTime(s){ const mm = Math.floor(s/60).toString().padStart(2,'0'); const ss = (s%60).toString().padStart(2,'0'); return `${mm}:${ss}`; }

  // Render functions
  function createCardElement(card, faceDown=false){
    const el = document.createElement('div');
    el.className = 'card' + (faceDown ? ' face-down' : '');
    el.dataset.id = card.id;
    el.dataset.suit = card.suit || '';
    el.dataset.rank = card.rank || '';
    // If card.img exists, use it as background
    if(card.img){
      el.style.backgroundImage = `url(${card.img})`;
      el.style.backgroundSize = 'cover';
      el.style.color = '#fff';
    } else {
      const color = (card.suit==='♥' || card.suit==='♦') ? 'red' : 'black';
      el.innerHTML = `<div class="small" style="color:${color}">${card.rank}${card.suit}</div><div style="align-self:flex-end;font-size:24px;text-align:right;color:${color}">${card.rank}${card.suit}</div>`;
    }
    // Events
    el.addEventListener('click', (ev)=> onCardClick(ev, card));
    return el;
  }

  function renderAll(){
    // stock and waste
    stockDom.innerHTML = ''; wasteDom.innerHTML = '';
    if(stock.length) stockDom.appendChild(createCardElement({id:'back'}, true));
    else { const p = document.createElement('div'); p.className='pile'; p.style.opacity=0.3; stockDom.appendChild(p); }
    if(waste.length) wasteDom.appendChild(createCardElement(waste[waste.length-1], false));

    // foundations
    foundationsDom.innerHTML = '';
    for(let i=0;i<4;i++){
      const p = document.createElement('div'); p.className='pile'; p.style.minHeight='var(--card-height)'; p.dataset.idx = i;
      if(foundations[i].length){
        p.appendChild(createCardEleme

