<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Black Moon Puzzle ‚Äî Rompecabezas</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{
    --bg:#04040a;
    --panel: linear-gradient(180deg,#0f0f13,#08080a);
    --accent:#9b5cff;
    --accent-2:#5cf0ff;
    --glass: rgba(255,255,255,0.03);
    --muted:#aeb0c6;
    --maxWidth:1100px;
  }
  *{box-sizing:border-box;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  html,body{height:100%;margin:0;background:
    radial-gradient(800px 400px at 10% 10%, rgba(155,92,255,0.06), transparent),
    radial-gradient(600px 300px at 90% 90%, rgba(92,240,255,0.03), transparent),
    var(--bg);
    color:#e8e8ee;
  }

  .wrap{max-width:var(--maxWidth);margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 340px;gap:20px;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  h1{margin:0;font-size:20px;letter-spacing:0.6px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:50%;background:conic-gradient(from 180deg at 50% 50%, #9b5cff, #5cf0ff, #001);box-shadow:0 6px 24px rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#08080a}
  .controls{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .boardWrap{background:linear-gradient(180deg,#0b0b0f,#071018);padding:14px;border-radius:12px;box-shadow:0 8px 36px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:12px}
  .topRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted)}
  select,input[type="number"]{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e8e8ee;padding:8px;border-radius:8px}
  button{background:linear-gradient(180deg,var(--accent), #6e2bff);border:none;padding:8px 12px;border-radius:10px;color:white;cursor:pointer}
  .secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;cursor:pointer;color:var(--muted)}
  .meta{display:flex;gap:12px;align-items:center;font-size:14px;color:#dfe0ff}
  .meta .box{background:var(--glass);padding:8px 10px;border-radius:8px;border:1px solid rgba(155,92,255,0.06)}
  .board{
    width:100%;
    aspect-ratio:1/1;
    display:grid;
    gap:6px;
    border-radius:10px;
    background:#000;
    overflow:hidden;
    position:relative;
  }
  .tile{
    border-radius:8px;
    background-size:100% 100%;
    background-repeat:no-repeat;
    cursor:pointer;
    user-select:none;
    transition: transform .12s ease, box-shadow .12s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,0.55);
  }
  .tile:active{transform:scale(.98)}
  .tile.blank{background:linear-gradient(180deg,#05050a,#0c0c0f);cursor:default;box-shadow:none}

  /* right column */
  .side{display:flex;flex-direction:column;gap:12px}
  .card{background:linear-gradient(180deg,#0f0f13,#08080a);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
  .small{font-size:13px;color:var(--muted)}
  .controlsGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .leaderboard table{width:100%;border-collapse:collapse}
  .leaderboard th,.leaderboard td{padding:6px;font-size:13px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
  footer{grid-column:1 / -1;text-align:center;color:var(--muted);margin-top:12px;font-size:13px}

  /* modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.6));z-index:200;display:none}
  .modal .box{background:#071018;padding:18px;border-radius:12px;min-width:300px;color:#e8e8ff}
  .confettiCanvas{position:absolute;inset:0;pointer-events:none;z-index:100}

  /* responsive */
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr; padding:12px;}
    .side{order:2}
  }

</style>
</head>
<body>
<div class="wrap">
  <header style="grid-column:1 / -1">
    <div class="brand">
      <div class="logo">BM</div>
      <div>
        <h1>Black Moon Puzzle</h1>
        <div class="small">Rompecabezas deslizante ‚Ä¢ 10 im√°genes ‚Ä¢ Black Moon</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="musicToggle" class="secondary">‚ñ∂Ô∏é M√∫sica</button>
      <button id="fxToggle" class="secondary">üîä FX</button>
    </div>
  </header>

  <div class="boardWrap">
    <div class="controls">
      <div class="topRow">
        <label>Imagen:
          <select id="imgSelect" aria-label="Seleccionar imagen">
            <option value="bkm systerms 2.0.jpg1">sistems</option>
            <option value="GPO BKM 2.jpg">grupop blackmoon</option>
            <option value="aerial black moon.jpg">aerial blackmoon</option>
            <option value="yo cadenas.jpg">charly</option>
            <option value="Imagen de WhatsApp 2025-08-27 a las 15.54.56_06e917a6.jpg">amigos del aire</option>
            <option value="f-01.png">media luna</option>
            <option value="f-02.png">scorpion doble</option>
            <option value="f-03.jpg">triangulo</option>
            <option value="f-04.jpg9">arco</option>
            <option value="f-05.jpg">split</option>
            <option value="f-06.jpg">portor</option>
            <option value="f-07.jpg">cama</option>
            <option value="f-08.jpg">split2 </option>
          </select>
        </label>

        <label>Tama√±o (n√ón):
          <input id="gridSize" type="number" min="2" max="8" value="3" />
        </label>

        <div style="display:flex;gap:8px;align-items:center">
          <label class="small">Modo:</label>
          <select id="modeSelect">
            <option value="normal">Normal</option>
            <option value="hard">Dif√≠cil</option>
            <option value="ultra">Ultra</option>
          </select>
        </div>

      </div>

      <div class="controlsGrid">
        <button id="shuffleBtn">Mezclar (animado)</button>
        <button id="resetBtn" class="secondary">Reiniciar</button>
        <button id="randomImgBtn" class="secondary">Imagen aleatoria</button>
        <button id="autoShuffleBtn" class="secondary">Auto-mezclar</button>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <div class="meta">
          <div class="box">Movimientos: <strong id="moves">0</strong></div>
          <div class="box">Tiempo: <strong id="time">00:00</strong></div>
        </div>
        <div style="margin-left:auto" class="small">Black Moon ‚Ä¢ v1</div>
      </div>
    </div>

    <div id="board" class="board" aria-label="Tablero del rompecabezas">
      <canvas id="confetti" class="confettiCanvas"></canvas>
    </div>

    <div id="message" class="small" style="text-align:center;color:#9be4ff"></div>
  </div>

  <aside class="side">
    <div class="card">
      <strong>Instrucciones</strong>
      <p class="small">Selecciona imagen y tama√±o. Pulsa <em>Mezclar</em> para iniciar (el bot√≥n realiza movimientos legales para asegurar solvencia). Modo Ultra aumenta dificultad y reduce tiempo.</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="scoreReset" class="secondary">Borrar ranking</button>
        <button id="exportBtn" class="secondary">Exportar ranking</button>
      </div>
    </div>

    <div class="card leaderboard">
      <strong>Ranking (mejores tiempos)</strong>
      <div class="small" style="margin-bottom:8px">Se guarda localmente por imagen/tama√±o/modo</div>
      <div style="max-height:220px;overflow:auto">
        <table id="leaderTable">
          <thead><tr><th>Pos</th><th>Nombre</th><th>Tiempo</th><th>Mov.</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <strong>Opciones extra</strong>
      <p class="small">Puedes desactivar m√∫sica y sonidos con los botones de arriba. El bot√≥n <em>Auto-mezclar</em> hace una mezcla completa con animaci√≥n.</p>
    </div>
  </aside>

  <footer>Hecho con ‚òΩ Black Moon ‚Äî copia y modifica como quieras.</footer>
</div>

<!-- Audio -->
<audio id="music" loop preload="auto">
  <source src="https://files.catbox.moe/2j7i6z.mp3" type="audio/mpeg">
</audio>
<audio id="fxMove" preload="auto">
  <source src="https://files.catbox.moe/0b9q24.mp3" type="audio/mpeg">
</audio>
<audio id="fxWin" preload="auto">
  <source src="https://files.catbox.moe/8y7w1q.mp3" type="audio/mpeg">
</audio>

<!-- Modal para guardar score -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <h3>¬°Felicidades! Puzzle resuelto üéâ</h3>
    <p class="small" id="modalStats"></p>
    <label class="small">Tu nombre:
      <input id="playerName" type="text" placeholder="Tu nombre" style="width:100%;padding:8px;border-radius:8px;margin-top:6px" />
    </label>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
      <button id="saveScoreBtn">Guardar</button>
      <button id="closeModalBtn" class="secondary">Cerrar</button>
    </div>
  </div>
</div>

<script>
/* ----------------------
   Variables y estado
   ---------------------- */
const boardEl = document.getElementById('board');
const confettiCanvas = document.getElementById('confetti');
const imgSelect = document.getElementById('imgSelect');
const gridInput = document.getElementById('gridSize');
const modeSelect = document.getElementById('modeSelect');
const shuffleBtn = document.getElementById('shuffleBtn');
const resetBtn = document.getElementById('resetBtn');
const randomImgBtn = document.getElementById('randomImgBtn');
const autoShuffleBtn = document.getElementById('autoShuffleBtn');
const movesEl = document.getElementById('moves');
const timeEl = document.getElementById('time');
const messageEl = document.getElementById('message');
const musicBtn = document.getElementById('musicToggle');
const fxBtn = document.getElementById('fxToggle');
const music = document.getElementById('music');
const fxMove = document.getElementById('fxMove');
const fxWin = document.getElementById('fxWin');
const leaderTableBody = document.querySelector('#leaderTable tbody');
const modal = document.getElementById('modal');
const playerName = document.getElementById('playerName');
const saveScoreBtn = document.getElementById('saveScoreBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const scoreResetBtn = document.getElementById('scoreReset');
const exportBtn = document.getElementById('exportBtn');

let gridSize = parseInt(gridInput.value,10) || 3;
let imageSrc = imgSelect.value;
let mode = modeSelect.value; // normal, hard, ultra
let tiles = []; // array of {index, pos, el}
let blankPos = null;
let moves = 0;
let timer = null;
let secondsLeft = 0;
let isShuffling = false;
let musicOn = false;
let fxOn = true;
const LEADER_KEY = 'bm_puzzle_scores_v1';

/* ----------------------
   Helpers
   ---------------------- */
function formatTimeSec(s){
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${mm}:${ss}`;
}
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ----------------------
   Tablero: creaci√≥n y render
   ---------------------- */
function setGrid(n){
  gridSize = n;
  boardEl.style.gridTemplateColumns = `repeat(${n},1fr)`;
  boardEl.style.gridTemplateRows = `repeat(${n},1fr)`;
  createTiles();
}

function createTiles(){
  // limpiar
  boardEl.querySelectorAll('.tile')?.forEach(el=>el.remove());
  tiles = [];
  moves = 0;
  movesEl.textContent = moves;
  clearInterval(timer); timer = null;
  timeEl.textContent = '00:00';
  messageEl.textContent = '';
  modal.style.display = 'none';

  const total = gridSize * gridSize;
  for(let i=0;i<total;i++){
    const el = document.createElement('div');
    el.className = 'tile';
    el.dataset.correct = i; // posici√≥n correcta
    el.dataset.pos = i;     // posici√≥n actual
    // estilo visual por defecto
    el.style.backgroundColor = '#111';
    el.addEventListener('click', onTileClick);
    tiles.push({index:i,pos:i,el});
    boardEl.appendChild(el);
  }
  blankPos = total - 1;
  tiles[blankPos].el.classList.add('blank');
  applyImageToTiles();
}

/* Calcula y aplica backgroundPosition seg√∫n index */
function applyImageToTiles(){
  const n = gridSize;
  const total = n*n;
  const sizePx = 800; // referencia para positioning (usamos background-size con %)
  const src = imageSrc || '';
  tiles.forEach(t=>{
    if(t.index === blankPos){
      t.el.classList.add('blank');
      t.el.style.backgroundImage = '';
      return;
    }
    t.el.classList.remove('blank');
    t.el.style.backgroundImage = `url("${src}")`;
    // usar background-size en % para reusar la imagen
    t.el.style.backgroundSize = `${n * 100}% ${n * 100}%`;
    const row = Math.floor(t.index / n);
    const col = t.index % n;
    const x = (col / (n-1)) * 100;
    const y = (row / (n-1)) * 100;
    t.el.style.backgroundPosition = `${x}% ${y}%`;
  });
  // blank visual
  tiles[blankPos].el.style.backgroundImage = '';
  tiles[blankPos].el.style.backgroundColor = '#06060a';
}

/* ----------------------
   Movimiento / l√≥gica
   ---------------------- */
function posToRC(pos){
  return {r: Math.floor(pos / gridSize), c: pos % gridSize};
}
function canMove(pos){
  const a = posToRC(pos), b = posToRC(blankPos);
  return Math.abs(a.r - b.r) + Math.abs(a.c - b.c) === 1;
}
function moveTile(pos, countMove=true){
  if(isShuffling) return;
  if(!canMove(pos)) return;
  const a = tiles.find(t=>t.pos===pos);
  const b = tiles.find(t=>t.pos===blankPos);
  // swap pos
  a.pos = blankPos;
  b.pos = pos;
  a.el.dataset.pos = a.pos;
  b.el.dataset.pos = b.pos;
  blankPos = pos;

  // reorder DOM by pos for simple placement
  const ordered = tiles.slice().sort((x,y)=>x.pos - y.pos);
  ordered.forEach(t=>boardEl.appendChild(t.el));

  if(countMove){
    moves++; movesEl.textContent = moves;
    if(fxOn) fxMove.currentTime = 0, fxMove.play().catch(()=>{});
    if(!timer) startTimerCountdown(); // start countdown when first move
    if(checkSolved()) onWin();
  }
}
function onTileClick(e){
  const pos = parseInt(e.currentTarget.dataset.pos,10);
  moveTile(pos);
}

/* ----------------------
   Mezclar (legal & animado)
   ---------------------- */
async function shuffleAnimated(steps=200, delay=12){
  if(isShuffling) return;
  isShuffling = true;
  // perform legal random moves
  let last = -1;
  for(let i=0;i<steps;i++){
    const n = gridSize;
    const b = posToRC(blankPos);
    const candidates = [];
    const dirs = [{r:b.r-1,c:b.c},{r:b.r+1,c:b.c},{r:b.r,c:b.c-1},{r:b.r,c:b.c+1}];
    for(const d of dirs){
      if(d.r>=0 && d.r<n && d.c>=0 && d.c<n){
        const p = d.r * n + d.c;
        if(p !== last) candidates.push(p);
      }
    }
    const pick = candidates[Math.floor(Math.random() * candidates.length)];
    moveTile(pick, false);
    last = blankPos;
    // little animation delay
    await new Promise(r => setTimeout(r, delay));
  }
  // after mixing, reset counters
  moves = 0; movesEl.textContent = moves;
  // reset timer based on mode
  setupTimerByMode();
  isShuffling = false;
}

/* ----------------------
   Timer (countdown) y modos
   ---------------------- */
function setupTimerByMode(){
  const base = (() => {
    if(mode === 'normal') return 180; // 3 min
    if(mode === 'hard') return 120;   // 2 min
    if(mode === 'ultra') return 60;   // 1 min
    return 180;
  })();
  // if ultra, increase default size if user left default small
  if(mode === 'ultra' && gridSize < 4){
    gridInput.value = 5;
    setGrid(5);
  }
  secondsLeft = base;
  timeEl.textContent = formatTimeSec(secondsLeft);
}
function startTimerCountdown(){
  if(timer) return;
  timer = setInterval(()=>{
    secondsLeft--;
    timeEl.textContent = formatTimeSec(secondsLeft);
    if(secondsLeft <= 0){
      clearInterval(timer); timer = null;
      onTimeOut();
    }
  },1000);
}
function stopTimer(){
  clearInterval(timer); timer = null;
}

/* ----------------------
   Fin del juego / victoria
   ---------------------- */
function checkSolved(){
  return tiles.every(t => t.pos === t.index);
}
function onWin(){
  stopTimer();
  const timeUsed = getModeBaseTime() - secondsLeft;
  messageEl.textContent = `¬°Resuelto! Tiempo: ${formatTimeSec(secondsLeft === 0 ? 0 : getModeBaseTime() - secondsLeft)} ‚Ä¢ Movimientos: ${moves}`;
  if(fxOn){ fxWin.currentTime = 0; fxWin.play().catch(()=>{}); }
  confettiBurst();
  openSaveModal(timeUsed, moves);
}
function onTimeOut(){
  messageEl.textContent = '‚è≥ Se agot√≥ el tiempo. Reinicia o vuelve a mezclar.';
  // small shake animation
  boardEl.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:360,iterations:1});
}

/* ----------------------
   Modal / Ranking (localStorage)
   ---------------------- */
function getModeBaseTime(){
  if(mode === 'normal') return 180;
  if(mode === 'hard') return 120;
  if(mode === 'ultra') return 60;
  return 180;
}
let lastResult = null;
function openSaveModal(timeUsed, movesCount){
  lastResult = {id:uid(), image:imageSrc, size:gridSize, mode, time:timeUsed, moves:movesCount, date:Date.now()};
  document.getElementById('modalStats').textContent = `Tiempo: ${formatTimeSec(timeUsed)} ‚Ä¢ Movimientos: ${movesCount}`;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  playerName.value = '';
  playerName.focus();
}
function closeModal(){
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
}
function saveScore(name){
  if(!lastResult) return;
  const list = JSON.parse(localStorage.getItem(LEADER_KEY) || '[]');
  list.push({...lastResult, name: name || 'Anon'});
  localStorage.setItem(LEADER_KEY, JSON.stringify(list));
  closeModal();
  renderLeaderboard();
}
function renderLeaderboard(){
  const list = JSON.parse(localStorage.getItem(LEADER_KEY) || '[]');
  // filter by current image+size+mode
  const filtered = list.filter(s => s.image === imageSrc && s.size === gridSize && s.mode === mode);
  filtered.sort((a,b) => a.time - b.time || a.moves - b.moves);
  leaderTableBody.innerHTML = '';
  for(let i=0;i<Math.min(12,filtered.length);i++){
    const s = filtered[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="width:26px">${i+1}</td><td>${escapeHtml(s.name)}</td><td>${formatTimeSec(s.time)}</td><td>${s.moves}</td>`;
    leaderTableBody.appendChild(tr);
  }
  if(filtered.length === 0){
    leaderTableBody.innerHTML = `<tr><td colspan="4" class="small">Sin registros para esta combinaci√≥n.</td></tr>`;
  }
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
saveScoreBtn.addEventListener('click', ()=> saveScore(playerName.value.trim()));
closeModalBtn.addEventListener('click', ()=> closeModal());

/* ----------------------
   Utilities: random image, export, delete scores
   ---------------------- */
randomImgBtn.addEventListener('click', ()=>{
  const idx = Math.floor(Math.random() * imgSelect.options.length);
  imgSelect.selectedIndex = idx;
  imageSrc = imgSelect.value;
  applyImageToTiles();
  renderLeaderboard();
});
scoreResetBtn.addEventListener('click', ()=>{
  if(confirm('Borrar todo el ranking guardado localmente?')){
    localStorage.removeItem(LEADER_KEY);
    renderLeaderboard();
  }
});
exportBtn.addEventListener('click', ()=>{
  const data = localStorage.getItem(LEADER_KEY) || '[]';
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'bm_puzzle_ranking.json'; a.click();
  URL.revokeObjectURL(url);
});

/* ----------------------
   Confetti (canvas particles)
   ---------------------- */
const confettiCtx = confettiCanvas.getContext?.('2d');
let confettiParticles = [];
function resizeConfetti(){
  confettiCanvas.width = boardEl.clientWidth;
  confettiCanvas.height = boardEl.clientHeight;
  confettiCanvas.style.left = boardEl.offsetLeft + 'px';
  confettiCanvas.style.top = boardEl.offsetTop + 'px';
}
window.addEventListener('resize', resizeConfetti);
function confettiBurst(){
  if(!confettiCtx) return;
  resizeConfetti();
  confettiParticles = [];
  const W = confettiCanvas.width, H = confettiCanvas.height;
  for(let i=0;i<80;i++){
    confettiParticles.push({
      x: W/2 + (Math.random()-0.5)*W*0.6,
      y: H/2 + (Math.random()-0.5)*H*0.2,
      vx: (Math.random()-0.5)*8,
      vy: - (2 + Math.random()*6),
      size: 6+Math.random()*8,
      color: (Math.random()>.5) ? 'rgba(155,92,255,0.95)' : 'rgba(92,240,255,0.95)',
      rot: Math.random()*360,
      vr: (Math.random()-0.5)*10
    });
  }
  let anim = true;
  function draw(){
    if(!anim) return;
    confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    confettiParticles.forEach(p=>{
      p.vy += 0.25; // gravity
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      confettiCtx.save();
      confettiCtx.translate(p.x,p.y);
      confettiCtx.rotate(p.rot * Math.PI/180);
      confettiCtx.fillStyle = p.color;
      confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
      confettiCtx.restore();
    });
    // remove offscreen
    confettiParticles = confettiParticles.filter(p => p.y < confettiCanvas.height + 60);
    if(confettiParticles.length>0){
      requestAnimationFrame(draw);
    } else anim = false;
  }
  draw();
}

/* ----------------------
   Event bindings
   ---------------------- */
imgSelect.addEventListener('change', ()=> {
  imageSrc = imgSelect.value;
  applyImageToTiles();
  renderLeaderboard();
});
gridInput.addEventListener('change', ()=> {
  let v = parseInt(gridInput.value,10) || 3;
  if(v < 2) v = 2;
  if(v > 8) v = 8;
  gridInput.value = v;
  setGrid(v);
  renderLeaderboard();
});
modeSelect.addEventListener('change', ()=> {
  mode = modeSelect.value;
  setupTimerByMode();
  renderLeaderboard();
});

shuffleBtn.addEventListener('click', ()=> {
  // steps depend on size & mode
  const base = gridSize * gridSize * (mode === 'ultra' ? 80 : (mode === 'hard' ? 60 : 40));
  shuffleAnimated(base, 10);
});
autoShuffleBtn.addEventListener('click', ()=> {
  // auto shuffle then start
  shuffleBtn.click();
  messageEl.textContent = 'Mezclando...';
  setTimeout(()=>{ messageEl.textContent = ''; }, 1200);
});
resetBtn.addEventListener('click', ()=> {
  setGrid(gridSize);
  setupTimerByMode();
  renderLeaderboard();
});

musicBtn.addEventListener('click', ()=> {
  musicOn = !musicOn;
  if(musicOn){
    music.play().catch(()=>{});
    musicBtn.textContent = '‚è∏ M√∫sica';
    musicBtn.classList.remove('secondary');
  } else {
    music.pause();
    musicBtn.textContent = '‚ñ∂Ô∏é M√∫sica';
    musicBtn.classList.add('secondary');
  }
});
fxBtn.addEventListener('click', ()=> {
  fxOn = !fxOn;
  fxBtn.textContent = fxOn ? 'üîä FX' : 'üîà FX';
  fxBtn.classList.toggle('secondary', !fxOn);
});

/* ----------------------
   Timeouts & helpers
   ---------------------- */
function onTimeOutReset(){
  // intentionally brief
  setGrid(gridSize);
}

/* Init */
imageSrc = imgSelect.value;
setGrid(gridSize);
setupTimerByMode();
renderLeaderboard();

/* Save modal via Enter key */
playerName.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') saveScore(playerName.value.trim());
});

/* small: if user closes modal with ESC */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeModal();
});

/* window click outside modal closes */
modal.addEventListener('click', (ev)=>{
  if(ev.target === modal) closeModal();
});

</script>
</body>
</html>
